define(["backbone","quill","color"],function(e,t,n){var r=e.View.extend({el:"#editor",initialize:function(){window.App.Views.Toolbar.model.on("change:font",this.setFont,this),window.App.Views.Toolbar.model.on("change:weight",this.setWeight,this),window.App.Views.Toolbar.model.on("change:color",this.setColor,this),window.App.Views.Toolbar.model.on("change:size",this.setSize,this),window.App.Views.Toolbar.model.on("change:height",this.setHeight,this),this.range={},this.quill=new t("#editor",{styles:{img:{width:"auto !important",position:"relative"}}}),this.quill.addModule("toolbar",{container:window.App.Views.Toolbar.$el[0]}),this.quill.on("selection-change",_.bind(this.setRange,this)),this.$el.addClass("ready")},setEditorHeight:function(){var e=null;$("#editor iframe").contents().find(".line").length&&(e=$("#editor iframe").contents().find(".line").last()),setTimeout(_.bind(function(){e?this.$el.css("height",e.offset().top+e.height()+150):this.$el.css("height","600px")},this),100)},setRange:function(e,t){this.range=e;var n=this.quill.getSelection()},setColor:function(e){var t=e.get("color");this.range&&this.range.start!==null&&this.range.end&&this.quill.formatText(this.range.start,this.range.end,{color:t})},setFont:function(e){var t=App.Collections.Fonts.find(function(t){return t.get("name")==e.get("font")});if(!t)return;this.quill.addStyles("css/"+e.get("font")+".css");var n=t.get("weights"),r=n.find(function(e){return e.get("def")});App.Views.Toolbar.model.set("weight",r.get("hash")),e.previousAttributes().font||this.setContent(t)},setContent:function(e){var t=e.get("defSize"),n=e.get("defHeight"),r=window.App.Views.Toolbar;this.quill.setContents($.parseJSON(e.get("defContent"))),r.model.set({sizeheightratio:n/t,size:t,height:t*(n/t)}),r.$("#sizeSelector .dragger").css({left:(t-12)/r.$("#sizeSelector .dragger").data("range")*r.$("#sizeSelector").innerWidth()}),r.$("#heightSelector .dragger").css({left:n/r.$("#heightSelector .dragger").data("range")*r.$("#heightSelector").innerWidth()})},setSize:function(e){var t=e.get("size"),n=e.get("sizeheightratio"),r=window.App.Views.Toolbar,i=r.$("#heightSelector .dragger"),s=Math.max(0,Math.min(t*n,i.data("range")-i.width()));e.set("height",s),this.quill.addStyles({body:{"font-size":t+"px"},img:{height:t+"px !important",top:t/10+"px"}})},setHeight:function(e){var t=e.get("height"),n=window.App.Views.Toolbar;n.$("#heightSelector .dragger").css({left:t/n.$("#heightSelector .dragger").data("range")*n.$("#heightSelector").innerWidth()}),this.quill.addStyles({body:{"line-height":t+"px"}}),n.model.set("sizeheightratio",e.get("height")/e.get("size"))},setWeight:function(e){this.range&&this.range.start!==null&&this.range.end&&this.quill.formatText(this.range.start,this.range.end,{font:e.get("weight")})},toggleColors:function(){this.oldops=[],this.newops=[];var e=this.quill.getContents();this.oldops=e.ops,$.each(e.ops,_.bind(function(e,t){this.newops.push(t);if(t.attributes.color)var r=this.invertColor(n(t.attributes.color).hex());else var r="#FFFFFF";this.newops[e].attributes.color=n(r).css()},this)),this.quill.setContents(this.newops)},invertColor:function(e){return"#"+("000000"+(16777215^parseInt(e.substring(1),16)).toString(16)).slice(-6)}});return r});